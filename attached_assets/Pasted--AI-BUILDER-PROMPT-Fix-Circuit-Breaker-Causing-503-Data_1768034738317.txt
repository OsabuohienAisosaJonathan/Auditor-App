üîß AI BUILDER PROMPT
Fix Circuit Breaker Causing 503 ‚ÄúDatabase Temporarily Unavailable‚Äù (Reserved VM)
The application is running on Replit Reserved VM (Dedicated).
Despite this, all auth and core endpoints are returning 503 immediately (0‚Äì3ms) with logs showing:
[Circuit Breaker] Rejecting ‚Ä¶ DB overloaded
Requests are rejected before DB queries run
Multiple auth endpoints (/login, /logout, /auth/me, /organization-settings) fail instantly
hasCookieHeader: true indicates repeated authenticated retries
This means the circuit breaker is tripping prematurely and never recovering, causing a full app lockout.
1Ô∏è‚É£ Identify the circuit breaker implementation (MANDATORY)
Search the entire codebase for:
Circuit breaker libraries (opossum, custom breaker, resilience logic)
Keywords: circuitBreaker, breaker.open, DB overloaded, retryAfter
Middleware that wraps DB access or auth routes
Output required:
File paths
Breaker configuration (thresholds, timeout, reset logic)
Whether breaker is global or per-route
2Ô∏è‚É£ Fix incorrect breaker thresholds (CRITICAL)
Current behavior proves:
Breaker opens on single or very few failures
Breaker rejects requests in 0‚Äì3ms
Breaker does NOT reset after cooldown
Implement safe production defaults:
Failure threshold ‚â• 50%
Minimum request volume before tripping ‚â• 10
Open state duration ‚â§ 10‚Äì15s
Half-open test requests enabled
Do NOT block login/logout endpoints permanently
3Ô∏è‚É£ Separate auth endpoints from heavy DB breaker
Auth endpoints MUST NOT be hard-blocked by a global DB breaker.
Refactor so that:
/login, /logout, /auth/me use:
lightweight DB access
separate breaker OR
graceful fallback (401/soft error)
Do not allow auth to cascade-fail the entire app.
4Ô∏è‚É£ Stop retry storms from the frontend
Evidence shows:
Multiple endpoints are retried automatically
Each retry re-triggers the breaker
This creates a self-DDOS loop
Fix by:
Ensuring frontend does NOT retry on 503
Ensuring server sends:
Retry-After
and client respects it
Prevent parallel calls to /auth/me, /organization-settings, /logout during failure
5Ô∏è‚É£ Fix DB connection pool mis-signal
Even if DB is healthy, breaker may think it‚Äôs overloaded due to:
Pool max too low
Connection acquire timeout too short
Pool exhaustion misreported as DB failure
Actions:
Log connection acquire time
Log pool size / usage
Increase pool size moderately
Increase acquire timeout (e.g. 5‚Äì10s)
6Ô∏è‚É£ Ensure breaker resets correctly (VERY IMPORTANT)
Confirm:
Breaker transitions:
CLOSED ‚Üí OPEN ‚Üí HALF-OPEN ‚Üí CLOSED
No permanent OPEN state
Restarting app should always reset breaker
If breaker state is stored in memory incorrectly or globally, fix it.
7Ô∏è‚É£ Required deliverables (NO SKIPPING)
Provide:
A. Exact file paths and modified sections
B. Before/after breaker configuration
C. Explanation of why breaker was falsely tripping
D. Proof that:
DB queries now execute
503 is returned only when DB is truly unavailable
Login works without lockout
üéØ Goal
Eliminate false ‚ÄúDB overloaded‚Äù lockouts, restore login stability, and ensure the app fails

