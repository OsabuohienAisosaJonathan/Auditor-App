PROMPT: Fix Admin Username + Password Flow (MiAuditOps)
Goal: Make admin (super admin) login reliable and controllable. I want the ability to set or reset the super admin username/email + password safely, without breaking existing users. Implement this with a clean “admin bootstrap + reset” flow.
A) Confirm current auth behavior
Identify how auth works now (session-based). Find the login handler (likely POST /api/auth/login) and the user table(s) used.
Confirm the user record fields used for login: username OR email, password hash, role.
B) Add a safe “Bootstrap Super Admin” mechanism
Create a server-only endpoint OR script that can:
Create the super admin if none exists, OR
Update the existing super admin credentials (username/email + password).
Protect it so it cannot be abused:
Only allow in development OR only allow with a secret key (e.g. ADMIN_BOOTSTRAP_KEY) in production.
If ADMIN_BOOTSTRAP_KEY is missing, endpoint must return 403.
Prefer idempotent upsert behavior:
If super admin exists: update username/email/password.
If none exists: create one.
C) Password rules + hashing
Ensure password is always hashed with bcrypt (or the existing hashing library).
Validate minimum password strength (e.g. 8+ chars) and return clear error messages.
D) Update login to be consistent
Login should accept email or username (case-insensitive).
Fix common failure causes:
trim spaces
lower-case email before compare
never allow multiple users with same email
Make sure session is created properly after successful login.
E) Add an Admin UI option (optional but recommended)
In Settings → Admin (visible only to super_admin):
“Change my password” (requires old password + new password)
“Change my username/email” (requires current password confirmation)
F) Required outputs
List exact file paths edited
Show first 10–15 lines of each edited file to confirm location
Provide code patches with START/END markers
Provide test checklist:
Login with username works
Login with email works
Bootstrap creates super admin if missing
Bootstrap updates password if admin exists
Password reset works and login succeeds after reset
No non-admin can access admin reset routes
Notes / Constraints
Do NOT redesign UI.
Keep existing DB structure; only add fields if absolutely necessary.
Ensure production-safe gating using ADMIN_BOOTSTRAP_KEY.
Log only non-sensitive diagnostics (never log passwords).