PROMPT: Fix SRD ↔ Client Department Linking + Add “Department Links / View Source” Drilldown

Fix the SRD-to-Client Department linking so it is truly functional (not just UI). Create a persistent, database-backed mapping between Client Department and SRD Department Store using Client + Outlet context (and used by date-based reconciliation).

1) Make SRD ↔ Client Department linking mandatory and real

In Inventory Management → Inv. Depts, update Create Inventory Department modal so users can select:

Stock Reconciliation Department (SRD) (dropdown)

Inventory Type (Main Store / Department Store)

Link to Client Department

This must be required for Department Store too (not only Main Store)

Only optional if Inventory Type is something not related to reconciliation (if any)

2) Save mapping in DB (persist it)

When user creates or updates the link, save a mapping record like:

clientId

outletId

clientDepartmentId

srdId

inventoryType

status (active/inactive)

createdBy

createdAt

3) Enforce uniqueness rules

Add validation + DB constraints so:

One Client Department cannot link to multiple SRDs on the same client + outlet

One SRD cannot link to multiple Client Departments on the same client + outlet

If you want to allow exceptions later, make it a deliberate “Allow Multiple” setting (default is strict = one-to-one).

4) Use this mapping everywhere reconciliation needs source tracking

Anywhere we compute reconciliation (especially the 2nd Hit Comparison), the system must use:

Client Department → linked SRD Department Store

This is what gives the audit chain: captured/declared values → stock audit values.

If a Client Department is not linked, show “Not linked” and provide a “Link Now” action.

5) Add “Department Links / Mapping” page

Create a new page/tab called:

Department Links / Mapping

This page lists all mappings for the selected Client + Outlet:

Columns:

Client Department

Linked SRD Store

Inventory Type

Status

Action: View Source

Also show a warning row for departments not linked:

Status = Not linked

Action button = Link Now (opens the linking modal)

6) Add “View Source” detail page/modal with item-level drilldown

When user clicks View Source, open a detail view (modal or page) for the selected Client Department + Date + Client + Outlet, showing:

A) Sales Evidence Summary

Total Captured (fetch from “Reported Payments Summary” for that department)

Total Declared (fetch from “Reported Payments Summary” for that department)

Show the Linked SRD Department Store name used as audit source

B) SRD Item-Level Audit Breakdown (for that date)

Show a table pulled from SRD Department Store ledger for that date:

Columns:

Item

Sold Qty

Selling Price (from Items table)

Amount Sold (Sold Qty × Selling Price)

Include totals at the bottom:

Total Sold Qty

Total Amount Sold

C) Reconciliation Summary

Show comparison:

SRD Amount Sold Total vs Total Declared

SRD Amount Sold Total vs Total Captured

Highlight mismatch clearly:

Balanced

Short

Excess
And show the difference in ₦.

7) Make it usable inside Recon page too (2nd Hit table)

In Reconciliation → 2nd Hit Comparison, make Audit (Dep) and “View Source” depend on the mapping:

Audit (Dep) must pull the SRD Amount Sold Total for the linked SRD store for that date.

If not linked → Audit (Dep) stays 0 or “—” and show “Not linked” with Link Now.

8) Don’t break existing structure

Do not change existing database structure unnecessarily. Only add the new mapping table + minimal references. Keep all changes consistent with the existing Client/Outlet/Date context logic already used in the app.